name: CD - Deploy to AKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  KUBE_NAMESPACE: default
  RESOURCE_GROUP: rg-cicd-mexico
  AKS_CLUSTER: aks-cicd-cluster

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure AKS credentials
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.RESOURCE_GROUP }}
        cluster-name: ${{ env.AKS_CLUSTER }}

    # ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è NUEVO PASO - AGREGAR AQU√ç ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
    - name: Attach ACR to AKS
      run: |
        echo "üîó Attaching ACR to AKS for image pull access..."
        az aks update \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER }} \
          --attach-acr $(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query [0].name -o tsv)
    # ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è NUEVO PASO - AGREGAR AQU√ç ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è

    - name: Deploy to AKS
      run: |
        # Replace image placeholders in manifests
        sed -i "s|IMAGE_PLACEHOLDER_API|${{ secrets.ACR_LOGIN_SERVER }}/api:${{ github.sha }}|g" manifests/api-deployment.yaml
        sed -i "s|IMAGE_PLACEHOLDER_WORKER|${{ secrets.ACR_LOGIN_SERVER }}/worker:${{ github.sha }}|g" manifests/worker-deployment.yaml
        
        # Apply manifests
        kubectl apply -f manifests/api-deployment.yaml
        kubectl apply -f manifests/worker-deployment.yaml
        
        # Verify deployment
        kubectl rollout status deployment/api-deployment --timeout=300s
        kubectl rollout status deployment/worker-deployment --timeout=300s
        
        # Get service info
        kubectl get services

    - name: Health check
      run: |
        sleep 30
        API_IP=$(kubectl get service api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        echo "Testing API at: http://$API_IP/health"
        curl -f http://$API_IP/health || exit 1
