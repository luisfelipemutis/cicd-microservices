name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  ACR_NAME: acr20251124230016
  RESOURCE_GROUP: rg-cicd_2-mexico

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    ###########################################################
    # üîç VALIDACI√ìN DE ESTRUCTURA API
    ###########################################################
    - name: Test API structure
      run: |
        echo "üîé Checking API structure..."
        cd api
        ls -la
        
        if [ ! -f "app.py" ]; then
          echo "‚ùå ERROR: app.py not found"
          exit 1
        fi

        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå ERROR: API Dockerfile not found"
          exit 1
        fi

        if [ ! -f "requirements.txt" ]; then
          echo "‚ùå ERROR: API requirements.txt not found"
          exit 1
        fi

        echo "‚úÖ API structure OK."


    ###########################################################
    # üîç VALIDACI√ìN DE ESTRUCTURA WORKER
    ###########################################################
    - name: Test Worker structure
      run: |
        echo "üîé Checking Worker structure..."
        cd worker
        ls -la

        if [ ! -f "worker.py" ]; then
          echo "‚ùå ERROR: worker.py not found"
          exit 1
        fi

        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå ERROR: Worker Dockerfile not found"
          exit 1
        fi

        echo "‚úÖ Worker structure OK."


  #############################################################
  # üì¶ BUILD & PUSH de im√°genes a ACR
  #############################################################
  build-and-push:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}


    ##############################################################
    # üöÄ BUILD API IMAGE
    ##############################################################
    - name: Build and push API image
      run: |
        echo "üì¶ Building API image..."
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image api:${{ github.sha }} \
          --image api:latest \
          --file api/Dockerfile \
          ./api/


    - name: Validate API image exists
      run: |
        echo "üîç Checking API tag in ACR..."
        FOUND=$(az acr repository show-tags \
          --name ${{ env.ACR_NAME }} \
          --repository api \
          --query "contains(@, '${{ github.sha }}')")

        if [[ "$FOUND" == "false" ]]; then
          echo "‚ùå ERROR: API image tag ${{ github.sha }} NOT FOUND in ACR!"
          exit 1
        fi

        echo "‚úÖ API image tag verified."


    ##############################################################
    # üè≠ BUILD WORKER IMAGE
    ##############################################################
    - name: Build and push Worker image
      run: |
        echo "üè≠ Building Worker image..."
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image worker:${{ github.sha }} \
          --image worker:latest \
          --file worker/Dockerfile \
          ./worker/


    - name: Validate Worker image exists
      run: |
        echo "üîç Checking Worker tag in ACR..."
        FOUND=$(az acr repository show-tags \
          --name ${{ env.ACR_NAME }} \
          --repository worker \
          --query "contains(@, '${{ github.sha }}')")

        if [[ "$FOUND" == "false" ]]; then
          echo "‚ùå ERROR: Worker image tag ${{ github.sha }} NOT FOUND in ACR!"
          exit 1
        fi

        echo "‚úÖ Worker image tag verified."


    ##############################################################
    # üìÑ Final List of Generated Images
    ##############################################################
    - name: Show final image list
      run: |
        echo "üìÑ Listing repositories:"
        az acr repository list --name ${{ env.ACR_NAME }} --output table

        echo "--- API tags ---"
        az acr repository show-tags --name ${{ env.ACR_NAME }} --repository api --output table

        echo "--- Worker tags ---"
        az acr repository show-tags --name ${{ env.ACR_NAME }} --repository worker --output table
