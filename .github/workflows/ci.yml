name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  ACR_NAME: acr20251124230016
  RESOURCE_GROUP: rg-cicd_2-mexico

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Test API structure
      run: |
        cd api
        ls -la
        [ -f "app.py" ] && echo "‚úÖ API app.py found" || exit 1
        [ - f "Dockerfile" ] && echo "‚úÖ API Dockerfile found" || exit 1
        [ -f "requirements.txt" ] && echo "‚úÖ API requirements.txt found" || exit 1
    
    - name: Test Worker structure  
      run: |
        cd worker
        ls -la
        [ -f "worker.py" ] && echo "‚úÖ Worker worker.py found" || exit 1
        [ -f "Dockerfile" ] && echo "‚úÖ Worker Dockerfile found" || exit 1

  build-and-push:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ACR Login
      run: |
        echo "üîê Logging into ACR..."
        az acr login --name ${{ env.ACR_NAME }}

    ##############################################################
    # BUILD + PUSH API WITHOUT ACR TASKS
    ##############################################################
    - name: Build API image locally
      run: |
        echo "üì¶ Building API image locally..."
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/api:${{ github.sha }} -t ${{ env.ACR_NAME }}.azurecr.io/api:latest api/

    - name: Push API image
      run: |
        echo "‚¨ÜÔ∏è Pushing API image..."
        docker push ${{ env.ACR_NAME }}.azurecr.io/api:${{ github.sha }}
        docker push ${{ env.ACR_NAME }}.azurecr.io/api:latest

    ##############################################################
    # BUILD + PUSH WORKER WITHOUT ACR TASKS
    ##############################################################
    - name: Build Worker image locally
      run: |
        echo "üè≠ Building Worker image locally..."
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/worker:${{ github.sha }} -t ${{ env.ACR_NAME }}.azurecr.io/worker:latest worker/

    - name: Push Worker image
      run: |
        echo "‚¨ÜÔ∏è Pushing Worker image..."
        docker push ${{ env.ACR_NAME }}.azurecr.io/worker:${{ github.sha }}
        docker push ${{ env.ACR_NAME }}.azurecr.io/worker:latest

    ##############################################################
    # VALIDACION FINAL
    ##############################################################
    - name: Validate tags in ACR
      run: |
        echo "üîç Checking images in ACR..."

        echo "--- API tags ---"
        az acr repository show-tags --name ${{ env.ACR_NAME }} --repository api --output table

        echo "--- Worker tags ---"
        az acr repository show-tags --name ${{ env.ACR_NAME }} --repository worker --output table
