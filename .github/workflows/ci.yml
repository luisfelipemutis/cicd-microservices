name: CI - Build, Test and Push Images

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Variables globales del pipeline.
# IMPORTANTE: estas variables ya funcionaban antes, as√≠ que NO se cambian.
env:
  ACR_NAME: acr20251124230016     # Nombre del Azure Container Registry
  RESOURCE_GROUP: rg-cicd_2-mexico

jobs:

  #########################################################################
  # JOB 1: TEST ‚Äî Valida estructura de carpetas y archivos
  #########################################################################
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # Verifica que la API tenga sus archivos esenciales
    - name: Test API structure
      run: |
        cd api
        ls -la
        [ -f "app.py" ] && echo "‚úÖ API app.py found" || (echo "‚ùå Missing app.py" && exit 1)
        [ -f "Dockerfile" ] && echo "‚úÖ API Dockerfile found" || (echo "‚ùå Missing Dockerfile" && exit 1)
        [ -f "requirements.txt" ] && echo "‚úÖ API requirements.txt found" || (echo "‚ùå Missing requirements.txt" && exit 1)

    # Verifica que el Worker tenga sus archivos esenciales
    - name: Test Worker structure  
      run: |
        cd worker
        ls -la
        [ -f "worker.py" ] && echo "‚úÖ Worker worker.py found" || (echo "‚ùå Missing worker.py" && exit 1)
        [ -f "Dockerfile" ] && echo "‚úÖ Worker Dockerfile found" || (echo "‚ùå Missing Dockerfile" && exit 1)


  #########################################################################
  # JOB 2: BUILD ‚Äî Construye y sube im√°genes al ACR
  #########################################################################
  build-and-push:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Login a Azure con service principal
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Login ACR ‚Äî Usa env.ACR_NAME porque as√≠ estaba funcionando correctamente
    - name: Login to ACR
      run: |
        echo "üîê Login to ACR: $ACR_NAME"
        az acr login --name $ACR_NAME

    #######################################################################
    # BUILD API IMAGE
    #######################################################################
    - name: Build API image
      run: |
        echo "üì¶ Building API image using Docker..."
        docker build -t $ACR_NAME.azurecr.io/api:${{ github.sha }} -t $ACR_NAME.azurecr.io/api:latest api/

        echo "‚¨ÜÔ∏è Pushing API image..."
        docker push $ACR_NAME.azurecr.io/api:${{ github.sha }}
        docker push $ACR_NAME.azurecr.io/api:latest

    #######################################################################
    # BUILD WORKER IMAGE
    #######################################################################
    - name: Build Worker image
      run: |
        echo "üè≠ Building Worker image using Docker..."
        docker build -t $ACR_NAME.azurecr.io/worker:${{ github.sha }} -t $ACR_NAME.azurecr.io/worker:latest worker/

        echo "‚¨ÜÔ∏è Pushing Worker image..."
        docker push $ACR_NAME.azurecr.io/worker:${{ github.sha }}
        docker push $ACR_NAME.azurecr.io/worker:latest

    #######################################################################
    # FINAL REPORT OF BUILT IMAGES
    #######################################################################
    - name: List images from ACR
      run: |
        echo "üìÑ Listing ACR repositories..."
        az acr repository list --name $ACR_NAME --output table

        echo "--- API tags ---"
        az acr repository show-tags --name $ACR_NAME --repository api --output table

        echo "--- Worker tags ---"
        az acr repository show-tags --name $ACR_NAME --repository worker --output table
