# .github/workflows/ci.yml
name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  API_IMAGE: ${{ secrets.ACR_LOGIN_SERVER }}/api:${{ github.sha }}
  WORKER_IMAGE: ${{ secrets.ACR_LOGIN_SERVER }}/worker:${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Test API structure
      run: |
        cd api
        ls -la
        echo "✅ API structure verified"
    
    - name: Test Worker structure  
      run: |
        cd worker
        ls -la
        echo "✅ Worker structure verified"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build and push API image
      run: |
        cd api
        docker build -t ${{ env.API_IMAGE }} .
        docker push ${{ env.API_IMAGE }}

    - name: Build and push Worker image
      run: |
        cd worker
        docker build -t ${{ env.WORKER_IMAGE }} .
        docker push ${{ env.WORKER_IMAGE }}

    - name: Store image tags
      run: |
        echo "API_IMAGE=${{ env.API_IMAGE }}" >> $GITHUB_ENV
        echo "WORKER_IMAGE=${{ env.WORKER_IMAGE }}" >> $GITHUB_ENV
