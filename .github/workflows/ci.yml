name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  ACR_NAME: acr20251124194858
  RESOURCE_GROUP: rg-cicd_1-mexico

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Test API structure
      run: |
        cd api
        ls -la
        [ -f "app.py" ] && echo "‚úÖ API app.py found" || exit 1
        [ -f "Dockerfile" ] && echo "‚úÖ API Dockerfile found" || exit 1
        [ -f "requirements.txt" ] && echo "‚úÖ API requirements.txt found" || exit 1
    
    - name: Test Worker structure  
      run: |
        cd worker
        ls -la
        [ -f "worker.py" ] && echo "‚úÖ Worker worker.py found" || exit 1
        [ -f "Dockerfile" ] && echo "‚úÖ Worker Dockerfile found" || exit 1

  build-and-push:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    ##############################################################
    # BUILD API IMAGE
    ##############################################################
    - name: Build and push API image
      run: |
        echo "üì¶ Building API image..."
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image api:${{ github.sha }} \
          --image api:latest \
          --file api/Dockerfile \
          ./api/

    - name: Validate API image exists
      run: |
        echo "üîç Checking API tag in ACR..."
        FOUND=$(az acr repository show-tags \
          --name ${{ env.ACR_NAME }} \
          --repository api \
          --query "contains(@, '${{ github.sha }}')")
        
        if [[ "$FOUND" == "false" ]]; then
          echo "‚ùå ERROR: API image tag ${{ github.sha }} NOT FOUND in ACR!"
          exit 1
        fi

        echo "‚úÖ API image tag verified."

    ##############################################################
    # BUILD WORKER IMAGE
    ##############################################################
    - name: Build and push Worker image
      run: |
        echo "üè≠ Building Worker image..."
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image worker:${{ github.sha }} \
          --image worker:latest \
          --file worker/Dockerfile \
          ./worker/

    - name: Validate Worker image exists
      run: |
        echo "üîç Checking Worker tag in ACR..."
        FOUND=$(az acr repository show-tags \
          --name ${{ env.ACR_NAME }} \
          --repository worker \
          --query "contains(@, '${{ github.sha }}')")
        
        if [[ "$FOUND" == "false" ]]; then
          echo "‚ùå ERROR: Worker image tag ${{ github.sha }} NOT FOUND in ACR!"
          exit 1
        fi

        echo "‚úÖ Worker image tag verified."

    ##############################################################
    # FINAL VERIFICATION
    ##############################################################
    - name: Show final image list
      run: |
        echo "üìÑ Listing repositories:"
        az acr repository list --name ${{ env.ACR_NAME }} --output table

        echo "--- API tags ---"
        az acr repository show-tags --name ${{ env.ACR_NAME }} --repository api --output table

        echo "--- Worker tags ---"
        az acr repository show-tags --name ${{ env.ACR_NAME }} --repository worker --output table